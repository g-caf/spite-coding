<!-- Details Header -->
<header class="details-header">
    <div class="details-header-top">
        <h2 class="details-title">Transaction Details</h2>
        <button onclick="hideTransactionDetails()" class="details-close">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="details-badges">
        <div class="status-badge <%= transaction.status %>">
            <%= transaction.status.charAt(0).toUpperCase() + transaction.status.slice(1) %>
        </div>
        <% if (transaction.category_id) { %>
            <% const category = categories.find(c => c.id === transaction.category_id); %>
            <% if (category) { %>
            <div class="category-pill">
                <span><%= category.name %></span>
            </div>
            <% } %>
        <% } %>
    </div>
</header>

<div class="details-content">
    <!-- Transaction Info Section -->
    <section class="details-section">
        <div class="transaction-info">
            <div class="transaction-info-main">
                <h3><%= transaction.description %></h3>
                <div class="transaction-info-details">
                    <div class="transaction-info-item">
                        <i class="fas fa-calendar transaction-info-icon"></i>
                        <span><%= transaction.formattedDate %></span>
                    </div>
                    <% if (transaction.merchant) { %>
                    <div class="transaction-info-item">
                        <i class="fas fa-store transaction-info-icon"></i>
                        <span><%= transaction.merchant %></span>
                    </div>
                    <% } %>
                    <% if (transaction.payment_method) { %>
                    <div class="transaction-info-item">
                        <i class="fas fa-credit-card transaction-info-icon"></i>
                        <span><%= transaction.payment_method %></span>
                    </div>
                    <% } %>
                </div>
            </div>
            <div class="transaction-info-amount">
                <%= transaction.formattedAmount %>
            </div>
        </div>
    </section>

    <!-- Category Assignment -->
    <section class="details-section">
        <h4 class="details-section-title">Category</h4>
        <form hx-post="/inbox/transaction/<%= transaction.id %>/category"
              hx-target="[data-transaction-id='<%= transaction.id %>']"
              hx-swap="outerHTML">
            <select name="categoryId" 
                    class="form-select"
                    onchange="this.form.requestSubmit()">
                <option value="">Select a category...</option>
                <% categories.forEach(category => { %>
                <option value="<%= category.id %>" 
                        <%= transaction.category_id === category.id ? 'selected' : '' %>>
                    <%= category.name %>
                </option>
                <% }); %>
            </select>
        </form>
        
        <!-- Quick Category Buttons -->
        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2); margin-top: var(--space-4);">
            <% categories.slice(0, 6).forEach(category => { %>
            <button hx-post="/inbox/transaction/<%= transaction.id %>/category"
                    hx-vals='{"categoryId": "<%= category.id %>"}'
                    hx-target="[data-transaction-id='<%= transaction.id %>']"
                    hx-swap="outerHTML"
                    class="category-pill <%= transaction.category_id === category.id ? 'selected' : '' %>" 
                    style="cursor: pointer; border: var(--border-width) solid var(--border-color); <%= transaction.category_id === category.id ? 'background-color: var(--color-accent); color: var(--color-white); border-color: var(--color-accent);' : '' %>">
                <span><%= category.name %></span>
            </button>
            <% }); %>
        </div>
    </section>

    <!-- Receipt Section -->
    <section class="details-section">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4);">
            <h4 class="details-section-title" style="margin-bottom: 0;">Receipt</h4>
        </div>
        
        <% if (transaction.receipt_url) { %>
        <div style="background-color: var(--color-gray-50); border-radius: var(--border-radius-lg); padding: var(--space-6);">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-3);">
                <div style="display: flex; align-items: center; gap: var(--space-3);">
                    <% if (transaction.receipt_url.endsWith('.pdf')) { %>
                    <i class="fas fa-file-pdf" style="font-size: 1.5rem; color: var(--color-red);"></i>
                    <% } else { %>
                    <i class="fas fa-image" style="font-size: 1.5rem; color: var(--color-accent);"></i>
                    <% } %>
                    <div>
                        <p style="font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-gray-900); margin-bottom: 0.25rem;">Receipt uploaded</p>
                        <p style="font-size: var(--text-xs); color: var(--color-gray-500);">Click to view full size</p>
                    </div>
                </div>
                <div style="display: flex; gap: var(--space-1);">
                    <button onclick="window.open('<%= transaction.receipt_url %>', '_blank')" 
                            class="btn-icon" 
                            title="View receipt">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" 
                            title="Delete receipt"
                            style="color: var(--color-red);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <!-- Image Preview -->
            <% if (!transaction.receipt_url.endsWith('.pdf')) { %>
            <div style="margin-top: var(--space-3);">
                <img src="<%= transaction.receipt_url %>" 
                     alt="Receipt preview" 
                     style="width: 100%; height: 8rem; object-fit: cover; border-radius: var(--border-radius); cursor: pointer;"
                     onclick="window.open('<%= transaction.receipt_url %>', '_blank')">
            </div>
            <% } %>
        </div>
        <% } else { %>
        <!-- Inline Upload Area -->
        <div class="transaction-upload-area" data-transaction-id="<%= transaction.id %>">
            <input type="file" 
                   id="file-input-details-<%= transaction.id %>" 
                   accept="image/*,.pdf" 
                   style="display: none;"
                   onchange="handleFileUpload(this, '<%= transaction.id %>')">
            <div class="upload-drop-zone" 
                 ondrop="handleDrop(event, '<%= transaction.id %>')"
                 ondragover="event.preventDefault(); event.currentTarget.classList.add('dragover')"
                 ondragleave="event.currentTarget.classList.remove('dragover')"
                 onclick="document.getElementById('file-input-details-<%= transaction.id %>').click()"
                 style="border: 2px dashed var(--border-color); border-radius: var(--border-radius-lg); padding: 2rem; text-align: center; cursor: pointer; transition: all var(--transition-fast);">
                <i class="fas fa-receipt" style="font-size: 2rem; color: var(--color-gray-300); margin-bottom: var(--space-3); display: block;"></i>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500); margin-bottom: var(--space-3);">Drop receipt here or click to browse</p>
                <div class="btn btn-secondary">
                    <i class="fas fa-upload"></i>
                    Upload Receipt
                </div>
            </div>
        </div>
        <% } %>
    </section>

    <!-- Notes Section -->
    <section class="details-section">
        <h4 class="details-section-title">Notes</h4>
        <form hx-post="/inbox/transaction/<%= transaction.id %>/notes"
              hx-trigger="blur changed"
              hx-target="this">
            <textarea name="notes" 
                      rows="4" 
                      placeholder="Add notes about this transaction..."
                      class="form-input"
                      style="resize: vertical; min-height: 6rem;"><%= transaction.notes || '' %></textarea>
        </form>
    </section>

    <!-- Action Buttons -->
    <section class="details-section">
        <div style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6);">
            <% if (transaction.status === 'categorized') { %>
            <button hx-post="/inbox/transaction/<%= transaction.id %>/approve"
                    hx-target="[data-transaction-id='<%= transaction.id %>']"
                    hx-swap="outerHTML"
                    class="btn btn-primary" 
                    style="flex: 1; background-color: var(--color-green); border-color: var(--color-green);">
                <i class="fas fa-check"></i>
                Approve
            </button>
            <button hx-post="/inbox/transaction/<%= transaction.id %>/reject"
                    hx-target="[data-transaction-id='<%= transaction.id %>']"
                    hx-swap="outerHTML"
                    class="btn btn-secondary" 
                    style="flex: 1; color: var(--color-red); border-color: var(--color-red);">
                <i class="fas fa-times"></i>
                Reject
            </button>
            <% } else if (transaction.status === 'unmatched') { %>
            <button disabled 
                    class="btn btn-secondary" 
                    style="flex: 1; opacity: 0.5; cursor: not-allowed;">
                <i class="fas fa-exclamation-triangle"></i>
                Needs Category
            </button>
            <% } else { %>
            <button class="btn btn-primary" style="flex: 1;">
                <i class="fas fa-edit"></i>
                Edit Transaction
            </button>
            <% } %>
        </div>
        
        <!-- Quick Actions & Metadata -->
        <div style="padding-top: var(--space-4); border-top: var(--border-width) solid var(--border-color);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: var(--space-4); font-size: var(--text-xs); color: var(--color-gray-500);">
                    <span>ID: <%= transaction.id %></span>
                    <span>Created: <%= transaction.created_at.toLocaleDateString() %></span>
                </div>
                <div style="display: flex; gap: var(--space-2);">
                    <button class="btn-icon" title="Duplicate transaction">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn-icon" title="Delete transaction" style="color: var(--color-red);">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
function hideTransactionDetails() {
    const detailsPanel = document.getElementById('transaction-details');
    detailsPanel.classList.add('hidden');
    
    // Remove selection from all cards
    document.querySelectorAll('.transaction-card').forEach(card => {
        card.classList.remove('selected');
    });
}

function handleDrop(event, transactionId) {
    event.preventDefault();
    event.currentTarget.classList.remove('dragover');
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0], transactionId);
    }
}

function handleFileUpload(input, transactionId) {
    if (input.files.length > 0) {
        uploadFile(input.files[0], transactionId);
    }
}

function uploadFile(file, transactionId) {
    const formData = new FormData();
    formData.append('receipt', file);
    formData.append('transactionId', transactionId);
    
    // Show uploading state
    const uploadArea = document.querySelector(`[data-transaction-id="${transactionId}"] .upload-drop-zone`);
    const originalHTML = uploadArea.innerHTML;
    uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: var(--space-3);"></i><p>Uploading...</p>';
    
    fetch('/inbox/receipt/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            uploadArea.innerHTML = '<i class="fas fa-check" style="font-size: 2rem; color: var(--color-green); margin-bottom: var(--space-3);"></i><p>Uploaded Successfully!</p>';
            // Refresh transaction details after 1 second
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            uploadArea.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--color-red); margin-bottom: var(--space-3);"></i><p>Upload Failed</p>';
            setTimeout(() => {
                uploadArea.innerHTML = originalHTML;
            }, 2000);
        }
    })
    .catch(error => {
        uploadArea.innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--color-red); margin-bottom: var(--space-3);"></i><p>Upload Error</p>';
        setTimeout(() => {
            uploadArea.innerHTML = originalHTML;
        }, 2000);
    });
}

// Close details panel when clicking outside
document.addEventListener('click', function(e) {
    const detailsPanel = document.getElementById('transaction-details');
    if (!detailsPanel.classList.contains('hidden') && 
        !detailsPanel.contains(e.target) && 
        !e.target.closest('.transaction-card')) {
        hideTransactionDetails();
    }
});

// Escape key to close
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideTransactionDetails();
    }
});
</script>