<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Receipt - <%= title || 'Expenses' %></title>
    <link rel="stylesheet" href="/css/receipt-theme.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://kit.fontawesome.com/your-kit-id.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="receipt-container">
        <!-- Fixed Receipt Header -->
        <div class="receipt-header">
            <div class="receipt-title">EXPENSE RECEIPT</div>
            <div class="receipt-subtitle">*** TRANSACTION SUMMARY ***</div>
            <div class="receipt-date">
                <%= new Date().toLocaleDateString('en-US', { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) %>
            </div>
        </div>

        <!-- Scrollable Transaction Body -->
        <div class="receipt-body" id="transaction-list">
            <% transactions.forEach((transaction, index) => { %>
            <div class="receipt-item" data-transaction-id="<%= transaction.id %>">
                <div class="receipt-item-left">
                    <div class="receipt-item-name">
                        <%= transaction.description %>
                    </div>
                    <div class="receipt-item-details">
                        <%= transaction.formattedDate %> 
                        <% if (transaction.merchant) { %>
                        | <%= transaction.merchant %>
                        <% } %>
                        <% if (transaction.payment_method) { %>
                        | <%= transaction.payment_method %>
                        <% } %>
                    </div>
                    <div class="receipt-item-status">
                        <span class="receipt-status <%= transaction.status %>">
                            <%= transaction.status %>
                        </span>
                        <% if (transaction.category_id) { %>
                            <% const category = categories.find(c => c.id === transaction.category_id); %>
                            <% if (category) { %>
                            | <%= category.name %>
                            <% } %>
                        <% } %>
                        <% if (transaction.receipt_url) { %>
                        | RECEIPT ATTACHED
                        <% } %>
                    </div>
                    
                    <!-- Inline Upload Area -->
                    <% if (!transaction.receipt_url) { %>
                    <div class="receipt-upload" 
                         onclick="document.getElementById('file-input-<%= transaction.id %>').click()"
                         ondrop="handleDrop(event, '<%= transaction.id %>')"
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('dragover')"
                         ondragleave="event.currentTarget.classList.remove('dragover')">
                        <i class="fas fa-paperclip"></i> ATTACH RECEIPT
                        <input type="file" 
                               id="file-input-<%= transaction.id %>" 
                               accept="image/*,.pdf" 
                               style="display: none;"
                               onchange="handleFileUpload(this, '<%= transaction.id %>')">
                    </div>
                    <% } else { %>
                    <div class="receipt-upload" style="border-color: #28a745; color: #28a745; background: #f8fff8;">
                        <i class="fas fa-check"></i> RECEIPT ATTACHED
                    </div>
                    <% } %>
                </div>
                
                <div class="receipt-item-right">
                    <div class="receipt-item-amount">
                        <%= transaction.formattedAmount %>
                    </div>
                </div>
            </div>
            <% }); %>
            
            <% if (transactions.length === 0) { %>
            <div class="receipt-item" style="text-align: center; font-style: italic; color: #888;">
                NO TRANSACTIONS FOUND
            </div>
            <% } %>
        </div>

        <!-- Fixed Receipt Footer -->
        <div class="receipt-footer">
            <div class="receipt-total-line"></div>
            <div class="receipt-total">
                TOTAL TRANSACTIONS: <%= transactions.length %>
                <br>
                <% 
                const totalAmount = transactions.reduce((sum, t) => sum + t.amount, 0);
                const formattedTotal = `$${(totalAmount / 100).toFixed(2)}`;
                %>
                TOTAL AMOUNT: <%= formattedTotal %>
            </div>
            <div class="receipt-total-line"></div>
            
            <div class="receipt-barcode">
                |||||| |||| | |||| |||||| | |||| ||||||
            </div>
            <div class="receipt-thanks">
                THANK YOU FOR TRACKING YOUR EXPENSES
                <br>
                EXPENSE PLATFORM v1.0
            </div>
        </div>
    </div>

    <script>
        function handleDrop(event, transactionId) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files[0], transactionId);
            }
        }

        function handleFileUpload(input, transactionId) {
            if (input.files.length > 0) {
                uploadFile(input.files[0], transactionId);
            }
        }

        function uploadFile(file, transactionId) {
            const formData = new FormData();
            formData.append('receipt', file);
            formData.append('transactionId', transactionId);
            
            // Show uploading state
            const uploadArea = document.querySelector(`[data-transaction-id="${transactionId}"] .receipt-upload`);
            const originalContent = uploadArea.innerHTML;
            uploadArea.innerHTML = '<i class="fas fa-spinner fa-spin"></i> UPLOADING...';
            uploadArea.style.borderColor = '#007bff';
            uploadArea.style.color = '#007bff';
            uploadArea.style.background = '#f0f8ff';
            
            fetch('/inbox/receipt/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    uploadArea.innerHTML = '<i class="fas fa-check"></i> RECEIPT UPLOADED!';
                    uploadArea.style.borderColor = '#28a745';
                    uploadArea.style.color = '#28a745';
                    uploadArea.style.background = '#f8fff8';
                    // Refresh the page after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    uploadArea.innerHTML = '<i class="fas fa-exclamation-triangle"></i> UPLOAD FAILED';
                    uploadArea.style.borderColor = '#dc3545';
                    uploadArea.style.color = '#dc3545';
                    uploadArea.style.background = '#fff8f8';
                    setTimeout(() => {
                        uploadArea.innerHTML = originalContent;
                        uploadArea.style.borderColor = '#ccc';
                        uploadArea.style.color = '#888';
                        uploadArea.style.background = '#fafafa';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                uploadArea.innerHTML = '<i class="fas fa-exclamation-triangle"></i> UPLOAD ERROR';
                uploadArea.style.borderColor = '#dc3545';
                uploadArea.style.color = '#dc3545';
                uploadArea.style.background = '#fff8f8';
                setTimeout(() => {
                    uploadArea.innerHTML = originalContent;
                    uploadArea.style.borderColor = '#ccc';
                    uploadArea.style.color = '#888';
                    uploadArea.style.background = '#fafafa';
                }, 2000);
            });
        }

        // Add smooth scrolling behavior
        document.documentElement.style.scrollBehavior = 'smooth';
        
        console.log('Receipt theme loaded successfully!');
    </script>
</body>
</html>
