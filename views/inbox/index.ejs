<!-- Sidebar - Filters and Overview -->
<aside class="app-sidebar custom-scrollbar">
    <!-- Search Section -->
    <div class="sidebar-section">
        <div style="position: relative;">
            <input type="text" 
                   id="search-input"
                   name="search" 
                   placeholder="Search transactions..."
                   value="<%= filters.search %>"
                   hx-get="/inbox/search"
                   hx-trigger="keyup changed delay:300ms, search"
                   hx-target="#transaction-list"
                   hx-include="[name='status']:checked, [name='category']:checked"
                   class="form-input"
                   style="padding-left: 2.5rem;">
            <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--color-gray-400); font-size: 0.875rem;"></i>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Status Overview</h3>
        <div class="status-overview">
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot unmatched"></div>
                    <span>Unmatched</span>
                </div>
                <span class="status-item-count"><%= statusCounts.unmatched || 0 %></span>
            </div>
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot categorized"></div>
                    <span>Categorized</span>
                </div>
                <span class="status-item-count"><%= statusCounts.categorized || 0 %></span>
            </div>
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot approved"></div>
                    <span>Approved</span>
                </div>
                <span class="status-item-count"><%= statusCounts.approved || 0 %></span>
            </div>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Filter by Status</h3>
        <div class="filter-group">
            <% const statusOptions = [
                { value: 'unmatched', label: 'Unmatched' },
                { value: 'categorized', label: 'Categorized' },
                { value: 'approved', label: 'Approved' },
                { value: 'rejected', label: 'Rejected' },
                { value: 'exported', label: 'Exported' }
            ]; %>
            <% statusOptions.forEach(status => { %>
            <label class="filter-item">
                <input type="checkbox" 
                       name="status" 
                       value="<%= status.value %>"
                       <%= filters.status.includes(status.value) ? 'checked' : '' %>
                       hx-get="/inbox/search"
                       hx-trigger="change"
                       hx-target="#transaction-list"
                       hx-include="#search-input, [name='status']:checked, [name='category']:checked"
                       class="filter-checkbox">
                <span class="filter-label"><%= status.label %></span>
            </label>
            <% }); %>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Filter by Category</h3>
        <div class="filter-group">
            <% categories.forEach(category => { %>
            <label class="filter-item">
                <input type="checkbox" 
                       name="category" 
                       value="<%= category.id %>"
                       <%= filters.category.includes(category.id) ? 'checked' : '' %>
                       hx-get="/inbox/search"
                       hx-trigger="change"
                       hx-target="#transaction-list"
                       hx-include="#search-input, [name='status']:checked, [name='category']:checked"
                       class="filter-checkbox">
                <div class="filter-label">
                    <%= category.name %>
                </div>
            </label>
            <% }); %>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="sidebar-section">
        <div id="bulk-actions" class="hidden">
            <h3 class="sidebar-section-title">
                Bulk Actions
                <span style="font-weight: normal; color: var(--color-gray-500);">(<span id="selected-count">0</span> selected)</span>
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <select id="bulk-category" class="form-select">
                    <option value="">Choose category...</option>
                    <% categories.forEach(category => { %>
                    <option value="<%= category.id %>"><%= category.name %></option>
                    <% }); %>
                </select>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="applyBulkAction('categorize')" class="btn btn-primary" style="flex: 1;">
                        Apply
                    </button>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="applyBulkAction('approve')" class="btn btn-secondary" style="flex: 1; background-color: var(--color-green-light); color: var(--color-green); border-color: var(--color-green);">
                        <i class="fas fa-check" style="margin-right: 0.25rem;"></i>
                        Approve
                    </button>
                    <button onclick="applyBulkAction('reject')" class="btn btn-secondary" style="flex: 1; background-color: var(--color-red-light); color: var(--color-red); border-color: var(--color-red);">
                        <i class="fas fa-times" style="margin-right: 0.25rem;"></i>
                        Reject
                    </button>
                </div>
            </div>
        </div>
        <div id="bulk-actions-placeholder" style="font-size: 0.875rem; color: var(--color-gray-500); text-align: center; padding: 1rem 0;">
            Select transactions to see bulk actions
        </div>
    </div>
</aside>

<!-- Central Feed -->
<main class="app-feed">
    <!-- Feed Header -->
    <header class="feed-header">
        <div class="feed-header-left">
            <input type="checkbox" 
                   id="select-all" 
                   class="feed-header-select-all">
            <span class="feed-header-count">
                <%= transactions.length %> transactions
            </span>
        </div>
        
        <div class="feed-header-actions">
            <button class="btn-icon" title="Refresh transactions">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <div style="display: flex; background-color: var(--color-gray-100); border-radius: var(--border-radius); padding: 0.125rem;">
                <button class="btn-icon" style="background-color: var(--color-white); box-shadow: var(--shadow-sm);" title="List view">
                    <i class="fas fa-list"></i>
                </button>
                <button class="btn-icon" title="Card view">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Transaction Feed -->
    <div class="transaction-feed custom-scrollbar" id="transaction-list">
        <%- include('../partials/transaction-list', { transactions, categories }) %>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.total > 1) { %>
    <footer style="padding: var(--space-6); border-top: var(--border-width) solid var(--border-color); background-color: var(--color-gray-50);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="font-size: var(--text-sm); color: var(--color-gray-600);">
                Page <%= pagination.current %> of <%= pagination.total %>
            </div>
            <div style="display: flex; gap: var(--space-2);">
                <% if (pagination.hasPrev) { %>
                <button hx-get="/inbox?page=<%= pagination.current - 1 %>"
                        hx-target="#transaction-list"
                        class="btn btn-secondary">
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </button>
                <% } %>
                <% if (pagination.hasNext) { %>
                <button hx-get="/inbox?page=<%= pagination.current + 1 %>"
                        hx-target="#transaction-list"
                        class="btn btn-secondary">
                    Next
                    <i class="fas fa-chevron-right"></i>
                </button>
                <% } %>
            </div>
        </div>
    </footer>
    <% } %>
</main>

<!-- Details Panel -->
<aside class="app-details hidden" id="transaction-details">
    <div id="transaction-details-content" class="details-content custom-scrollbar">
        <!-- Details will be loaded here via HTMX -->
    </div>
</aside>

<!-- CSS for inline upload areas -->
<style>
.transaction-upload-area {
    margin-bottom: 0.5rem;
}

.upload-drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    background-color: var(--color-gray-50);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
    font-size: 0.875rem;
}

.upload-drop-zone:hover {
    border-color: var(--color-accent);
    background-color: var(--color-gray-100);
}

.upload-drop-zone.dragover {
    border-color: var(--color-accent);
    background-color: var(--color-accent-light);
    transform: scale(1.02);
}

.upload-drop-zone i {
    color: var(--color-gray-500);
}

.upload-drop-zone:hover i {
    color: var(--color-accent);
}
</style>

<script>
// Enhanced bulk actions handling
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const bulkActions = document.getElementById('bulk-actions');
    const placeholder = document.getElementById('bulk-actions-placeholder');
    const selectedCount = document.getElementById('selected-count');
    
    if (checkboxes.length > 0) {
        bulkActions.classList.remove('hidden');
        placeholder.classList.add('hidden');
        selectedCount.textContent = checkboxes.length;
    } else {
        bulkActions.classList.add('hidden');
        placeholder.classList.remove('hidden');
    }
}

// Select all functionality
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
    });
    updateBulkActions();
});

// Individual checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('transaction-checkbox')) {
        updateBulkActions();
        
        // Update select-all state
        const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const selectAll = document.getElementById('select-all');
        
        selectAll.checked = allCheckboxes.length === checkedCheckboxes.length;
        selectAll.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }
});



// Enhanced bulk actions
function applyBulkAction(action) {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const transactionIds = Array.from(checkboxes).map(cb => cb.dataset.transactionId);
    
    if (transactionIds.length === 0) return;
    
    let payload = { transactionIds, action };
    
    if (action === 'categorize') {
        const categoryId = document.getElementById('bulk-category').value;
        if (!categoryId) {
            alert('Please select a category first.');
            return;
        }
        payload.categoryId = categoryId;
    }
    
    // Use HTMX for bulk actions
    htmx.ajax('POST', '/inbox/bulk-action', {
        values: payload,
        target: '#transaction-list',
        swap: 'innerHTML'
    });
}
</script>