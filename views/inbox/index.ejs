<!-- Sidebar - Filters and Overview -->
<aside class="app-sidebar custom-scrollbar">
    <!-- Search Section -->
    <div class="sidebar-section">
        <div style="position: relative;">
            <input type="text" 
                   id="search-input"
                   name="search" 
                   placeholder="Search transactions..."
                   value="<%= filters.search %>"
                   hx-get="/inbox/search"
                   hx-trigger="keyup changed delay:300ms, search"
                   hx-target="#transaction-list"
                   hx-include="[name='status']:checked, [name='category']:checked"
                   class="form-input"
                   style="padding-left: 2.5rem;">
            <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--color-gray-400); font-size: 0.875rem;"></i>
        </div>
    </div>

    <!-- Status Overview -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Status Overview</h3>
        <div class="status-overview">
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot unmatched"></div>
                    <span>Unmatched</span>
                </div>
                <span class="status-item-count"><%= statusCounts.unmatched || 0 %></span>
            </div>
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot categorized"></div>
                    <span>Categorized</span>
                </div>
                <span class="status-item-count"><%= statusCounts.categorized || 0 %></span>
            </div>
            <div class="status-item">
                <div class="status-item-label">
                    <div class="status-dot approved"></div>
                    <span>Approved</span>
                </div>
                <span class="status-item-count"><%= statusCounts.approved || 0 %></span>
            </div>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Filter by Status</h3>
        <div class="filter-group">
            <% const statusOptions = [
                { value: 'unmatched', label: 'Unmatched' },
                { value: 'categorized', label: 'Categorized' },
                { value: 'approved', label: 'Approved' },
                { value: 'rejected', label: 'Rejected' },
                { value: 'exported', label: 'Exported' }
            ]; %>
            <% statusOptions.forEach(status => { %>
            <label class="filter-item">
                <input type="checkbox" 
                       name="status" 
                       value="<%= status.value %>"
                       <%= filters.status.includes(status.value) ? 'checked' : '' %>
                       hx-get="/inbox/search"
                       hx-trigger="change"
                       hx-target="#transaction-list"
                       hx-include="#search-input, [name='status']:checked, [name='category']:checked"
                       class="filter-checkbox">
                <span class="filter-label"><%= status.label %></span>
            </label>
            <% }); %>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="sidebar-section">
        <h3 class="sidebar-section-title">Filter by Category</h3>
        <div class="filter-group">
            <% categories.forEach(category => { %>
            <label class="filter-item">
                <input type="checkbox" 
                       name="category" 
                       value="<%= category.id %>"
                       <%= filters.category.includes(category.id) ? 'checked' : '' %>
                       hx-get="/inbox/search"
                       hx-trigger="change"
                       hx-target="#transaction-list"
                       hx-include="#search-input, [name='status']:checked, [name='category']:checked"
                       class="filter-checkbox">
                <div class="filter-label">
                    <span style="margin-right: 0.5rem;"><%= category.icon %></span>
                    <%= category.name %>
                </div>
            </label>
            <% }); %>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="sidebar-section">
        <div id="bulk-actions" class="hidden">
            <h3 class="sidebar-section-title">
                Bulk Actions
                <span style="font-weight: normal; color: var(--color-gray-500);">(<span id="selected-count">0</span> selected)</span>
            </h3>
            
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <select id="bulk-category" class="form-select">
                    <option value="">Choose category...</option>
                    <% categories.forEach(category => { %>
                    <option value="<%= category.id %>"><%= category.icon %> <%= category.name %></option>
                    <% }); %>
                </select>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="applyBulkAction('categorize')" class="btn btn-primary" style="flex: 1;">
                        Apply
                    </button>
                </div>
                
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="applyBulkAction('approve')" class="btn btn-secondary" style="flex: 1; background-color: var(--color-green-light); color: var(--color-green); border-color: var(--color-green);">
                        <i class="fas fa-check" style="margin-right: 0.25rem;"></i>
                        Approve
                    </button>
                    <button onclick="applyBulkAction('reject')" class="btn btn-secondary" style="flex: 1; background-color: var(--color-red-light); color: var(--color-red); border-color: var(--color-red);">
                        <i class="fas fa-times" style="margin-right: 0.25rem;"></i>
                        Reject
                    </button>
                </div>
            </div>
        </div>
        <div id="bulk-actions-placeholder" style="font-size: 0.875rem; color: var(--color-gray-500); text-align: center; padding: 1rem 0;">
            Select transactions to see bulk actions
        </div>
    </div>
</aside>

<!-- Central Feed -->
<main class="app-feed">
    <!-- Feed Header -->
    <header class="feed-header">
        <div class="feed-header-left">
            <input type="checkbox" 
                   id="select-all" 
                   class="feed-header-select-all">
            <span class="feed-header-count">
                <%= transactions.length %> transactions
            </span>
        </div>
        
        <div class="feed-header-actions">
            <button class="btn-icon" title="Refresh transactions">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <div style="display: flex; background-color: var(--color-gray-100); border-radius: var(--border-radius); padding: 0.125rem;">
                <button class="btn-icon" style="background-color: var(--color-white); box-shadow: var(--shadow-sm);" title="List view">
                    <i class="fas fa-list"></i>
                </button>
                <button class="btn-icon" title="Card view">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Transaction Feed -->
    <div class="transaction-feed custom-scrollbar" id="transaction-list">
        <%- include('../partials/transaction-list', { transactions, categories }) %>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.total > 1) { %>
    <footer style="padding: var(--space-6); border-top: var(--border-width) solid var(--border-color); background-color: var(--color-gray-50);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="font-size: var(--text-sm); color: var(--color-gray-600);">
                Page <%= pagination.current %> of <%= pagination.total %>
            </div>
            <div style="display: flex; gap: var(--space-2);">
                <% if (pagination.hasPrev) { %>
                <button hx-get="/inbox?page=<%= pagination.current - 1 %>"
                        hx-target="#transaction-list"
                        class="btn btn-secondary">
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </button>
                <% } %>
                <% if (pagination.hasNext) { %>
                <button hx-get="/inbox?page=<%= pagination.current + 1 %>"
                        hx-target="#transaction-list"
                        class="btn btn-secondary">
                    Next
                    <i class="fas fa-chevron-right"></i>
                </button>
                <% } %>
            </div>
        </div>
    </footer>
    <% } %>
</main>

<!-- Details Panel -->
<aside class="app-details hidden" id="transaction-details">
    <div id="transaction-details-content" class="details-content custom-scrollbar">
        <!-- Details will be loaded here via HTMX -->
    </div>
</aside>

<!-- Receipt Upload Modal -->
<div id="receipt-modal" class="hidden" style="position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 100;">
    <div style="background: white; border-radius: var(--border-radius-lg); padding: 2rem; max-width: 32rem; width: 100%; margin: 1rem; box-shadow: var(--shadow-lg);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="font-size: var(--text-lg); font-weight: var(--font-semibold); color: var(--color-gray-900);">Upload Receipt</h3>
            <button onclick="closeReceiptModal()" class="btn-icon">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="receipt-form" enctype="multipart/form-data">
            <input type="hidden" id="receipt-transaction-id" name="transactionId">
            
            <!-- Drag & Drop Area -->
            <div id="drop-zone" 
                 style="border: 2px dashed var(--border-color); border-radius: var(--border-radius-lg); padding: 3rem; text-align: center; cursor: pointer; transition: all var(--transition-fast);"
                 onmouseover="this.style.borderColor = 'var(--color-accent)'; this.style.backgroundColor = 'var(--color-gray-50)'"
                 onmouseout="this.style.borderColor = 'var(--border-color)'; this.style.backgroundColor = 'transparent'">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--color-gray-400); margin-bottom: 1rem; display: block;"></i>
                <p style="color: var(--color-gray-600); margin-bottom: 0.5rem; font-weight: var(--font-medium);">Drag and drop your receipt here, or click to browse</p>
                <p style="font-size: var(--text-sm); color: var(--color-gray-500);">Supports JPG, PNG, GIF, and PDF files up to 10MB</p>
                <input type="file" id="receipt-file" name="receipt" accept="image/*,.pdf" style="display: none;">
            </div>
            
            <!-- Preview -->
            <div id="file-preview" class="hidden" style="margin-top: 1rem; padding: 1rem; background-color: var(--color-gray-50); border-radius: var(--border-radius);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <i class="fas fa-file-alt" style="color: var(--color-accent);"></i>
                        <span id="file-name" style="font-size: var(--text-sm); font-weight: var(--font-medium);"></span>
                    </div>
                    <button type="button" onclick="clearFile()" class="btn-icon" style="color: var(--color-red);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden" style="margin-top: 1rem;">
                <div style="background-color: var(--color-gray-200); border-radius: 9999px; height: 0.5rem; overflow: hidden;">
                    <div style="background-color: var(--color-accent); height: 100%; border-radius: 9999px; width: 0%; transition: width var(--transition);"></div>
                </div>
            </div>
            
            <div style="display: flex; gap: var(--space-3); margin-top: 2rem;">
                <button type="button" onclick="closeReceiptModal()" class="btn btn-secondary" style="flex: 1;">
                    Cancel
                </button>
                <button type="submit" id="upload-btn" disabled class="btn btn-primary" style="flex: 1;">
                    Upload Receipt
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Enhanced bulk actions handling
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const bulkActions = document.getElementById('bulk-actions');
    const placeholder = document.getElementById('bulk-actions-placeholder');
    const selectedCount = document.getElementById('selected-count');
    
    if (checkboxes.length > 0) {
        bulkActions.classList.remove('hidden');
        placeholder.classList.add('hidden');
        selectedCount.textContent = checkboxes.length;
    } else {
        bulkActions.classList.add('hidden');
        placeholder.classList.remove('hidden');
    }
}

// Select all functionality
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.transaction-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
    });
    updateBulkActions();
});

// Individual checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('transaction-checkbox')) {
        updateBulkActions();
        
        // Update select-all state
        const allCheckboxes = document.querySelectorAll('.transaction-checkbox');
        const checkedCheckboxes = document.querySelectorAll('.transaction-checkbox:checked');
        const selectAll = document.getElementById('select-all');
        
        selectAll.checked = allCheckboxes.length === checkedCheckboxes.length;
        selectAll.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
    }
});

// Receipt modal functions
function openReceiptModal(transactionId) {
    document.getElementById('receipt-transaction-id').value = transactionId;
    document.getElementById('receipt-modal').classList.remove('hidden');
}

function closeReceiptModal() {
    document.getElementById('receipt-modal').classList.add('hidden');
    clearFile();
}

function clearFile() {
    document.getElementById('receipt-file').value = '';
    document.getElementById('file-preview').classList.add('hidden');
    document.getElementById('upload-btn').disabled = true;
}

// Drag and drop functionality
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('receipt-file');

dropZone.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', function() {
    if (this.files[0]) {
        document.getElementById('file-name').textContent = this.files[0].name;
        document.getElementById('file-preview').classList.remove('hidden');
        document.getElementById('upload-btn').disabled = false;
    }
});

// Enhanced bulk actions
function applyBulkAction(action) {
    const checkboxes = document.querySelectorAll('.transaction-checkbox:checked');
    const transactionIds = Array.from(checkboxes).map(cb => cb.dataset.transactionId);
    
    if (transactionIds.length === 0) return;
    
    let payload = { transactionIds, action };
    
    if (action === 'categorize') {
        const categoryId = document.getElementById('bulk-category').value;
        if (!categoryId) {
            alert('Please select a category first.');
            return;
        }
        payload.categoryId = categoryId;
    }
    
    // Use HTMX for bulk actions
    htmx.ajax('POST', '/inbox/bulk-action', {
        values: payload,
        target: '#transaction-list',
        swap: 'innerHTML'
    });
}
</script>